# @format

name: Web UI Docker Build and Deploy

permissions:
  contents: read
  id-token: write

on:
  workflow_run:
    workflows: ['Java CI with Maven']
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    if: (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || github.event_name == 'workflow_dispatch'
    environment: Production
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      # Extract short SHA for use throughout workflow
      - name: Extract short SHA
        id: sha
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "short=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "::notice::Short SHA: $SHORT_SHA"

      # Validate all required secrets exist (fail-fast principle)
      - name: Validate required secrets and configuration
        run: |
          set -euo pipefail
          
          echo "::group::Validating deployment prerequisites"
          
          MISSING_SECRETS=""
          MISSING_VARS=""
          
          # Critical secrets validation
          [ -z "${{ secrets.AZURE_API_KEY }}" ] && MISSING_SECRETS="$MISSING_SECRETS AZURE_API_KEY"
          [ -z "${{ secrets.DATABASE_URL }}" ] && MISSING_SECRETS="$MISSING_SECRETS DATABASE_URL"
          [ -z "${{ secrets.AUTH_GOOGLE_SECRET }}" ] && MISSING_SECRETS="$MISSING_SECRETS AUTH_GOOGLE_SECRET"
          [ -z "${{ secrets.AZURE_AISEARCH_KEY }}" ] && MISSING_SECRETS="$MISSING_SECRETS AZURE_AISEARCH_KEY"
          [ -z "${{ secrets.REDIS_PASSWORD }}" ] && MISSING_SECRETS="$MISSING_SECRETS REDIS_PASSWORD"
          [ -z "${{ secrets.FLAGSMITH_SDK_KEY }}" ] && MISSING_SECRETS="$MISSING_SECRETS FLAGSMITH_SDK_KEY"
          [ -z "${{ secrets.OPENID_KEY_TEXT }}" ] && MISSING_SECRETS="$MISSING_SECRETS OPENID_KEY_TEXT"
          
          # Variables validation
          [ -z "${{ vars.NEXT_PUBLIC_DEFAULT_AI_MODEL }}" ] && MISSING_VARS="$MISSING_VARS NEXT_PUBLIC_DEFAULT_AI_MODEL"
          [ -z "${{ vars.NEXT_PUBLIC_HOSTNAME }}" ] && MISSING_VARS="$MISSING_VARS NEXT_PUBLIC_HOSTNAME"
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "::error::Missing required secrets:$MISSING_SECRETS"
            echo "::error::Please configure these secrets in GitHub Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          if [ -n "$MISSING_VARS" ]; then
            echo "::error::Missing required variables:$MISSING_VARS"
            echo "::error::Please configure these variables in GitHub Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          echo "✅ All required secrets and variables are present"
          echo "::endgroup::"

      - name: Free up disk space on runner
        run: |
          echo "Disk space before cleanup:"
          df -h
          
          echo "Cleaning up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune --all --force --volumes
          sudo apt-get clean
          
          echo "Disk space after cleanup:"
          df -h
    
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      - name: Log in to Azure Container Registry
        run: az acr login --name schoollawregistry

      # Create build-time environment file (scoped to build step only)
      - name: Generate build environment configuration
        run: |
          set -euo pipefail
          
          echo "::group::Creating build environment file"
          
          # Create .env.production.local with all build-time variables
          cat << 'ENV_EOF' > ./web-ui/packages/app/.env.production.local
          # Public variables (safe to embed in client bundle)
          NEXT_PUBLIC_MUI_LICENSE=${{ secrets.NEXT_PUBLIC_MUI_LICENSE }}
          NEXT_PUBLIC_AZURE_MONITOR_CONNECTION_STRING=${{ secrets.NEXT_PUBLIC_AZURE_MONITOR_CONNECTION_STRING }}
          NEXT_PUBLIC_DEFAULT_AI_MODEL=${{ vars.NEXT_PUBLIC_DEFAULT_AI_MODEL }}
          NEXT_PUBLIC_HOSTNAME=${{ vars.NEXT_PUBLIC_HOSTNAME }}
          NEXT_PUBLIC_LOG_LEVEL_CLIENT=${{ vars.NEXT_PUBLIC_LOG_LEVEL_CLIENT }}
          NEXT_PUBLIC_FLAGSMITH_API_URL=${{ vars.NEXT_PUBLIC_FLAGSMITH_API_URL }}
          NEXT_PUBLIC_FLAGSMITH_ENVIRONMENT_ID=${{ vars.NEXT_PUBLIC_FLAGSMITH_ENVIRONMENT_ID }}
          
          # OpenTelemetry configuration
          OTEL_SERVICE_NAME=${{ vars.OTEL_SERVICE_NAME }}
          OTEL_RESOURCE_ATTRIBUTES=${{ vars.OTEL_RESOURCE_ATTRIBUTES }}
          
          # Azure service endpoints (non-sensitive)
          AZURE_OPENAI_ENDPOINT=${{ vars.AZURE_OPENAI_ENDPOINT }}
          AZURE_AISEARCH_ENDPOINT=${{ vars.AZURE_AISEARCH_ENDPOINT }}
          AZURE_AISEARCH_DOCUMENTS_INDEX_NAME=${{ vars.AZURE_AISEARCH_DOCUMENTS_INDEX_NAME }}
          AZURE_AISEARCH_POLICY_INDEX_NAME=${{ vars.AZURE_AISEARCH_POLICY_INDEX_NAME }}
          AZURE_STORAGE_ACCOUNT_NAME=${{ vars.AZURE_STORAGE_ACCOUNT_NAME }}
          
          # Mem0 configuration
          MEM0_UI_HOST=${{ vars.MEM0_UI_HOST }}
          MEM0_USERNAME=${{ vars.MEM0_USERNAME }}
          MEM0_API_HOST=${{ vars.MEM0_API_HOST }}
          
          # OAuth configuration (client IDs are public)
          AUTH_GOOGLE_ID=${{ secrets.AUTH_GOOGLE_ID }}
          
          # Server-side secrets (NOT embedded in client bundle)
          AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          AZURE_API_KEY=${{ secrets.AZURE_API_KEY }}
          AZURE_AISEARCH_KEY=${{ secrets.AZURE_AISEARCH_KEY }}
          AUTH_GOOGLE_SECRET=${{ secrets.AUTH_GOOGLE_SECRET }}
          AUTH_GOOGLE_APIKEY=${{ secrets.AUTH_GOOGLE_APIKEY }}
          AZURE_STORAGE_ACCOUNT_KEY=${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          FLAGSMITH_SDK_KEY=${{ secrets.FLAGSMITH_SDK_KEY }}
          OPENID_KEY_TEXT=${{ secrets.OPENID_KEY_TEXT }}
          ENV_EOF
          
          # Validate the file was created
          if [ ! -f ./web-ui/packages/app/.env.production.local ]; then
            echo "::error::Failed to create .env.production.local file"
            exit 1
          fi
          
          echo "✅ Build environment file created with $(wc -l < ./web-ui/packages/app/.env.production.local) variables"
          echo "::endgroup::"

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: schoollawregistry.azurecr.io/full-ui
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value={{branch}}-${{ steps.sha.outputs.short }}

      # Build Docker image with environment file
      - name: Build and push Docker image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: ./web-ui
          file: ./web-ui/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=schoollawregistry.azurecr.io/full-ui:buildcache
          cache-to: type=registry,ref=schoollawregistry.azurecr.io/full-ui:buildcache,mode=max
          build-args: |
            BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
            NEXT_PUBLIC_HOSTNAME=${{ vars.NEXT_PUBLIC_HOSTNAME }}
            NEXT_PUBLIC_LOG_LEVEL_CLIENT=${{ vars.NEXT_PUBLIC_LOG_LEVEL_CLIENT }}
            NEXT_PUBLIC_DEFAULT_AI_MODEL=${{ vars.NEXT_PUBLIC_DEFAULT_AI_MODEL }}
            NEXT_PUBLIC_DATAGRID_CLIENT_CACHE_TIMEOUT=15
            NEXT_PUBLIC_FLAGSMITH_API_URL=${{ vars.NEXT_PUBLIC_FLAGSMITH_API_URL }}
            NEXT_PUBLIC_FLAGSMITH_ENVIRONMENT_ID=${{ vars.NEXT_PUBLIC_FLAGSMITH_ENVIRONMENT_ID }}
            OTEL_SERVICE_NAME=${{ vars.OTEL_SERVICE_NAME }}
            OTEL_RESOURCE_ATTRIBUTES=${{ vars.OTEL_RESOURCE_ATTRIBUTES }}
            RATE_RETRY_INTERVAL_MINUTES=${{ vars.RATE_RETRY_INTERVAL_MINUTES }}
            AZURE_OPENAI_ENDPOINT=${{ vars.AZURE_OPENAI_ENDPOINT }}
            AZURE_AISEARCH_ENDPOINT=${{ vars.AZURE_AISEARCH_ENDPOINT }}
            AZURE_AISEARCH_DOCUMENTS_INDEX_NAME=${{ vars.AZURE_AISEARCH_DOCUMENTS_INDEX_NAME }}
            AZURE_AISEARCH_POLICY_INDEX_NAME=${{ vars.AZURE_AISEARCH_POLICY_INDEX_NAME }}
            AZURE_STORAGE_ACCOUNT_NAME=${{ vars.AZURE_STORAGE_ACCOUNT_NAME }}
            AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
            MEM0_API_HOST=${{ vars.MEM0_API_HOST }}
            MEM0_UI_HOST=${{ vars.MEM0_UI_HOST }}
            MEM0_USERNAME=${{ vars.MEM0_USERNAME }}
          secrets: |
            AZURE_API_KEY=${{ secrets.AZURE_API_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            AUTH_GOOGLE_SECRET=${{ secrets.AUTH_GOOGLE_SECRET }}
            AZURE_AISEARCH_KEY=${{ secrets.AZURE_AISEARCH_KEY }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            FLAGSMITH_SDK_KEY=${{ secrets.FLAGSMITH_SDK_KEY }}
            OPENID_KEY_TEXT=${{ secrets.OPENID_KEY_TEXT }}
            NEXT_PUBLIC_MUI_LICENSE=${{ secrets.NEXT_PUBLIC_MUI_LICENSE }}
            NEXT_PUBLIC_AZURE_MONITOR_CONNECTION_STRING=${{ secrets.NEXT_PUBLIC_AZURE_MONITOR_CONNECTION_STRING }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            AUTH_GOOGLE_APIKEY=${{ secrets.AUTH_GOOGLE_APIKEY }}
            AUTH_GOOGLE_SECRET=${{ secrets.AUTH_GOOGLE_SECRET }}
            AUTH_GOOGLE_ID=${{ secrets.AUTH_GOOGLE_ID }}
            AZURE_STORAGE_ACCOUNT_KEY=${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
            AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
            OPENID_KEY_TEXT=${{ secrets.OPENID_KEY_TEXT }}
            FLAGSMITH_SDK_KEY=${{ secrets.FLAGSMITH_SDK_KEY }}
          secret-files: |
            "env_file=./web-ui/packages/app/.env.production.local"

      # Clean up sensitive files immediately after build
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f ./web-ui/packages/app/.env.production.local
          echo "✅ Sensitive files removed"

      # Extract and validate deploy tag with audit logging
      - name: Extract and validate deploy tag
        id: deploy_tag
        run: |
          set -euo pipefail
          
          echo "::group::Deploy tag extraction and validation"
          
          # Log deployment context for audit trail
          echo "::notice::Deployment Context"
          echo "::notice::  Branch: ${{ github.ref_name }}"
          echo "::notice::  Commit: ${{ github.sha }}"
          echo "::notice::  Short SHA: ${{ steps.sha.outputs.short }}"
          echo "::notice::  Actor: ${{ github.actor }}"
          echo "::notice::  Run ID: ${{ github.run_id }}"
          echo "::notice::  Triggered by: ${{ github.event_name }}"
          
          # Extract deploy tag from metadata
          DEPLOY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | grep "${{ github.ref_name }}-${{ steps.sha.outputs.short }}" | head -n1 || true)
          
          # Validate tag was extracted
          if [ -z "$DEPLOY_TAG" ]; then
            echo "::error::Failed to extract deploy tag"
            echo "::error::Pattern: ${{ github.ref_name }}-${{ steps.sha.outputs.short }}"
            echo "::error::Available tags:"
            echo "${{ steps.meta.outputs.tags }}" | while IFS= read -r line; do
              echo "::error::  - $line"
            done
            exit 1
          fi
          
          # Set output for next step
          echo "tag=$DEPLOY_TAG" >> $GITHUB_OUTPUT
          
          # Audit log
          echo "::notice::Deploy Tag Selected: $DEPLOY_TAG"
          echo "::notice::Image Digest: ${{ steps.docker_build.outputs.digest }}"
          echo "::endgroup::"

      # Deploy with full audit logging
      - name: Deploy to Azure Container Apps
        id: deploy
        uses: azure/container-apps-deploy-action@v1
        with:
          imageToDeploy: ${{ steps.deploy_tag.outputs.tag }}
          acrName: schoollawregistry
          containerAppName: full-ui
          resourceGroup: SchoolLawyer
        #env:
        #  # Deployment metadata for audit trail
        #  DEPLOY_TIMESTAMP: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        #  DEPLOY_ACTOR: ${{ github.actor }}
        #  DEPLOY_RUN_ID: ${{ github.run_id }}
        #  DEPLOY_COMMIT: ${{ github.sha }}
        #  DEPLOY_BRANCH: ${{ github.ref_name }}

      # Post-deployment verification and audit logging
      - name: Verify deployment and create audit log
        if: success()
        run: |
          set -euo pipefail
          
          echo "::group::Deployment Verification and Audit"
          
          # Create deployment audit record
          cat << AUDIT_EOF
          ========================================
          DEPLOYMENT AUDIT RECORD
          ========================================
          Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          Environment: Production
          Service: Title IX Victim Advocacy Platform - Web UI
          
          Deployment Details:
            - Image: ${{ steps.deploy_tag.outputs.tag }}
            - Digest: ${{ steps.docker_build.outputs.digest }}
            - Resource Group: SchoolLawyer
            - Container App: full-ui
            - Registry: schoollawregistry.azurecr.io
          
          Source Control:
            - Repository: ${{ github.repository }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ steps.sha.outputs.short }} ( ${{ github.sha }} )
          
          Workflow:
            - Triggered by: ${{ github.event_name }}
            - Actor: ${{ github.actor }}
            - Run ID: ${{ github.run_id }}
            - Run Number: ${{ github.run_number }}
            - Attempt: ${{ github.run_attempt }}
          
          Compliance Notes:
            - FERPA compliance: Enabled
            - Audit logging: Enabled
            - OpenTelemetry tracing: Configured
            - Azure Monitor: Connected
          ========================================
          AUDIT_EOF
          
          echo "::notice::✅ Deployment completed successfully"
          echo "::notice::Image: ${{ steps.deploy_tag.outputs.tag }}"
          echo "::notice::Run ID: ${{ github.run_id }} for audit reference"
          echo "::endgroup::"

      # Error handling and notification
      - name: Handle deployment failure
        if: failure()
        run: |
          echo "::error::Deployment failed for Title IX Platform Web UI"
          echo "::error::Run ID: ${{ github.run_id }}"
          echo "::error::Commit: ${{ github.sha }}"
          echo "::error::Please review logs and contact platform team"
          echo "::error::Critical: Victim advocacy services may be impacted"
