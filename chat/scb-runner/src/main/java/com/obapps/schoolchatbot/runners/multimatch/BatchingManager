package com.obapps.schoolchatbot.runners.multimatch;

public class BatchingManager {

  private final Map<String, List<String>> queryMatchCache = new HashMap<>();
  private final Map<String, Integer> offsetTracker = new HashMap<>();
  private final int batchSize = 10;

  public void addMatches(String queryId, List<String> matches) {
    queryMatchCache.put(queryId, new ArrayList<>(matches));
    offsetTracker.put(queryId, 0);
  }

  public List<String> getNextBatch(String queryId) {
    List<String> matches = queryMatchCache.getOrDefault(queryId, List.of());
    int currentOffset = offsetTracker.getOrDefault(queryId, 0);
    int end = Math.min(currentOffset + batchSize, matches.size());
    List<String> batch = matches.subList(currentOffset, end);
    offsetTracker.put(queryId, end);
    return batch;
  }

  public boolean hasMore(String queryId) {
    List<String> matches = queryMatchCache.getOrDefault(queryId, List.of());
    return offsetTracker.getOrDefault(queryId, 0) < matches.size();
  }

  public void reset(String queryId) {
    queryMatchCache.remove(queryId);
    offsetTracker.remove(queryId);
  }

  public int getCurrentOffset(String queryId) {
    return offsetTracker.getOrDefault(queryId, 0);
  }
}

// Example Tool Stub: continueMatchRetrieval
// This tool gets called by the LLM when more matches are needed
public interface MatchContinuationTool {
  @Tool(
    name = "continueMatchRetrieval",
    value = "Returns the next batch of 10 matches for a given queryId in an ongoing list evaluation. Only call this if the previous response said more matches exist."
  )
  List<String> continueMatchRetrieval(@P("queryId") String queryId);
}

// LLMContinuationRunner.java
// Coordinates LLM output continuation using the batching manager

public class LLMContinuationRunner {}
// Usage in System Prompt:
/*
You are expected to return ALL matches, even if there are more than 10. If more than 10 results exist, continue listing them by calling the continueMatchRetrieval tool.
The tool will return the next 10 results based on the provided queryId.
Never summarize or conclude your list until all results have been retrieved and listed.
*/
